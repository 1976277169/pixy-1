#!/bin/bash

echo "=========================================================="
echo "  Configuring libpixyusb"
echo "=========================================================="

rm -rf configuration
mkdir configuration

## Define library dependencies ##

LIBUSB="libusb-1.0.a"
LIBBOOST="libboost_thread.a"

# Identify operating system #

UNAME=`uname`
case $UNAME in
	"Linux")
		echo "__LINUX__" > configuration/OS;;
  "Darwin")
		echo "__MACOS__" > configuration/OS;;
	"OpenBSD")
		echo "__OPENBSD__" > confiugration/OS;;
	"FreeBSD" )
		echo "__FREEBSD__" > confiugration/OS;;
esac

## Query C++11 support ##

echo -n "checking for C++11 support: "

echo "#include<thread>"                  > testcpp11.cpp
echo "#include<mutex>"                  >> testcpp11.cpp
echo "int main(int a, char * b[])"      >> testcpp11.cpp
echo "{ std::thread t; std::mutex m; }" >> testcpp11.cpp
g++ -std=c++11 testcpp11.cpp 2> /dev/null

if [ $? -eq 0 ]; then
  echo "g++ supports C++11"
  HAS_CXX11="YES"
  echo "YES" > configuration/CXX11_AVAILABLE
else
  echo ".. not found"
fi

rm testcpp11.cpp
rm a.out

## Find libboost ##

echo -n "dependency: libboost "

find /usr 2> /dev/null | grep $LIBBOOST$ | sed -n 's/'$LIBBOOST'//p' > configuration/LIBBOOST_PATH

if [[ -s configuration/LIBBOOST_PATH ]]; then
  HAS_BOOST=YES
	echo -n "found: "
	cat "configuration/LIBBOOST_PATH"
  echo "YES" > configuration/BOOST_AVAILABLE
else
  echo ".. not found"
  echo ""
fi

if [[ -z $HAS_BOOST && -z $HAS_Cxx11 ]]; then
  echo "Please install libboost-all-dev then re-run ./configure"
  exit 1
fi

## Find libusb ##

echo -n "dependency: libusb "

find /usr 2> /dev/null | grep $LIBUSB$ | sed -n 's/'$LIBUSB'//p' > configuration/LIBUSB_PATH

if [[ -s configuration/LIBUSB_PATH ]]; then
	echo -n "found: "
	cat "configuration/LIBUSB_PATH"
else
  echo ".. not found"
  echo ""
  echo "Please install libusb 1.0-0-dev then re-run ./configure"
  echo ""
	exit 1
fi

touch configuration/READY

echo ""
echo "Configuration complete. Please run make."
